<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSA åŠ å¯†æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 20px; }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h2 {
            margin-top: 0;
            color: #555;
            font-size: 18px;
        }
        textarea {
            width: 100%;
            height: 100px;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .test-result {
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” RSA åŠ å¯†ä¿®å¤æµ‹è¯•</h1>

        <!-- æµ‹è¯• 1ï¼šè·å–å…¬é’¥ -->
        <div class="section">
            <h2>æµ‹è¯• 1ï¼šè·å–å…¬é’¥</h2>
            <button onclick="testGetPublicKey()">è·å–å…¬é’¥</button>
            <div id="status1" class="status info">ç­‰å¾…æµ‹è¯•...</div>
            <div style="margin-top: 10px;">
                <label>å…¬é’¥å†…å®¹ï¼š</label>
                <textarea id="publicKey" readonly></textarea>
            </div>
        </div>

        <!-- æµ‹è¯• 2ï¼šæ ¼å¼åŒ–å…¬é’¥ -->
        <div class="section">
            <h2>æµ‹è¯• 2ï¼šæ ¼å¼åŒ–å…¬é’¥</h2>
            <button onclick="testFormatPublicKey()">æ ¼å¼åŒ–å…¬é’¥</button>
            <div id="status2" class="status info">ç­‰å¾…æµ‹è¯•...</div>
            <div style="margin-top: 10px;">
                <label>æ ¼å¼åŒ–åçš„å…¬é’¥ï¼š</label>
                <textarea id="formattedPublicKey" readonly></textarea>
            </div>
        </div>

        <!-- æµ‹è¯• 3ï¼šæµ‹è¯•åŠ å¯† -->
        <div class="section">
            <h2>æµ‹è¯• 3ï¼šJSEncrypt åŠ å¯†æµ‹è¯•</h2>
            <input type="text" id="testPassword" value="test123" placeholder="è¾“å…¥æµ‹è¯•å¯†ç " style="padding: 10px; width: 200px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="testEncryption()">åŠ å¯†æµ‹è¯•</button>
            <div id="status3" class="status info">ç­‰å¾…æµ‹è¯•...</div>
            <div class="test-result" id="encryptionResult"></div>
        </div>

        <!-- æµ‹è¯• 4ï¼šå®Œæ•´ç™»å½•æµ‹è¯• -->
        <div class="section">
            <h2>æµ‹è¯• 4ï¼šå®Œæ•´ç™»å½•æµ‹è¯•</h2>
            <input type="text" id="testUsername" value="admin" placeholder="ç”¨æˆ·å" style="padding: 10px; width: 150px; border: 1px solid #ccc; border-radius: 4px;">
            <input type="password" id="testPasswordLogin" value="admin123" placeholder="å¯†ç " style="padding: 10px; width: 150px; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="testLogin()">ç™»å½•æµ‹è¯•</button>
            <div id="status4" class="status info">ç­‰å¾…æµ‹è¯•...</div>
            <div class="test-result" id="loginResult"></div>
        </div>

        <!-- æµ‹è¯•æ€»ç»“ -->
        <div class="section">
            <h2>ğŸ“Š æµ‹è¯•æ€»ç»“</h2>
            <div id="summary" class="test-result">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script>
        let testResults = {
            publicKey: false,
            formatPublicKey: false,
            encryption: false,
            login: false
        };

        // ç¡®ä¿ PEM æ ¼å¼æ­£ç¡®ï¼ˆåŒ…å«æ¢è¡Œç¬¦ï¼‰
        function ensureValidPemFormat(publicKey) {
            const cleanKey = publicKey.trim();

            if (cleanKey.includes('-----BEGIN PUBLIC KEY-----') &&
                cleanKey.includes('-----END PUBLIC KEY-----') &&
                !cleanKey.includes('\n')) {

                const start = '-----BEGIN PUBLIC KEY-----';
                const end = '-----END PUBLIC KEY-----';
                const base64Part = cleanKey
                    .substring(start.length)
                    .substring(0, cleanKey.length - start.length - end.length)
                    .trim();

                const formattedBase64 = base64Part.match(/.{1,64}/g).join('\n');
                return `${start}\n${formattedBase64}\n${end}`;
            }

            return cleanKey;
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // æ›´æ–°æ€»ç»“
        function updateSummary() {
            const results = [
                `âœ“ è·å–å…¬é’¥: ${testResults.publicKey ? 'é€šè¿‡' : 'å¤±è´¥'}`,
                `âœ“ æ ¼å¼åŒ–å…¬é’¥: ${testResults.formatPublicKey ? 'é€šè¿‡' : 'å¤±è´¥'}`,
                `âœ“ åŠ å¯†æµ‹è¯•: ${testResults.encryption ? 'é€šè¿‡' : 'å¤±è´¥'}`,
                `âœ“ ç™»å½•æµ‹è¯•: ${testResults.login ? 'é€šè¿‡' : 'å¤±è´¥/æœªæµ‹è¯•'}`
            ];

            const allPassed = testResults.publicKey && testResults.formatPublicKey && testResults.encryption;
            const summary = results.join('\n') + '\n\n' + (allPassed ? 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼RSA åŠ å¯†ä¿®å¤æˆåŠŸï¼' : 'âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯ã€‚');

            document.getElementById('summary').textContent = summary;
        }

        // æµ‹è¯• 1ï¼šè·å–å…¬é’¥
        async function testGetPublicKey() {
            try {
                showStatus('status1', 'æ­£åœ¨è·å–å…¬é’¥...', 'info');

                const response = await fetch('http://localhost:8080/api/rsa/public-key');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const publicKey = data.data.publicKey;

                document.getElementById('publicKey').value = publicKey;

                console.log('åŸå§‹å…¬é’¥é•¿åº¦:', publicKey.length);
                console.log('åŒ…å«æ¢è¡Œç¬¦:', publicKey.includes('\n'));
                console.log('å…¬é’¥æ ¼å¼:', data.data);

                showStatus('status1', 'âœ“ å…¬é’¥è·å–æˆåŠŸï¼', 'success');
                testResults.publicKey = true;
            } catch (error) {
                console.error('è·å–å…¬é’¥å¤±è´¥:', error);
                showStatus('status1', `âœ— è·å–å…¬é’¥å¤±è´¥: ${error.message}`, 'error');
                testResults.publicKey = false;
            }

            updateSummary();
        }

        // æµ‹è¯• 2ï¼šæ ¼å¼åŒ–å…¬é’¥
        function testFormatPublicKey() {
            try {
                const publicKey = document.getElementById('publicKey').value;

                if (!publicKey) {
                    throw new Error('è¯·å…ˆè·å–å…¬é’¥');
                }

                showStatus('status2', 'æ­£åœ¨æ ¼å¼åŒ–å…¬é’¥...', 'info');

                const formattedKey = ensureValidPemFormat(publicKey);
                document.getElementById('formattedPublicKey').value = formattedKey;

                console.log('æ ¼å¼åŒ–åå…¬é’¥é•¿åº¦:', formattedKey.length);
                console.log('æ ¼å¼åŒ–ååŒ…å«æ¢è¡Œç¬¦:', formattedKey.includes('\n'));

                showStatus('status2', 'âœ“ å…¬é’¥æ ¼å¼åŒ–æˆåŠŸï¼', 'success');
                testResults.formatPublicKey = true;
            } catch (error) {
                console.error('æ ¼å¼åŒ–å…¬é’¥å¤±è´¥:', error);
                showStatus('status2', `âœ— æ ¼å¼åŒ–å¤±è´¥: ${error.message}`, 'error');
                testResults.formatPublicKey = false;
            }

            updateSummary();
        }

        // æµ‹è¯• 3ï¼šåŠ å¯†æµ‹è¯•
        function testEncryption() {
            try {
                const formattedKey = document.getElementById('formattedPublicKey').value;
                const password = document.getElementById('testPassword').value;

                if (!formattedKey) {
                    throw new Error('è¯·å…ˆæ ¼å¼åŒ–å…¬é’¥');
                }

                showStatus('status3', 'æ­£åœ¨åŠ å¯†æµ‹è¯•...', 'info');

                const encrypt = new JSEncrypt();
                encrypt.setPublicKey(formattedKey);

                const encrypted = encrypt.encrypt(password);

                if (encrypted === false) {
                    throw new Error('JSEncrypt åŠ å¯†å¤±è´¥ï¼Œå…¬é’¥æ ¼å¼å¯èƒ½ä¸æ­£ç¡®');
                }

                const result = {
                    åŸå§‹å¯†ç : password,
                    åŠ å¯†ç»“æœ: encrypted.substring(0, 50) + '...',
                    å¯†æ–‡é•¿åº¦: encrypted.length,
                    åŠ å¯†çŠ¶æ€: 'æˆåŠŸ'
                };

                document.getElementById('encryptionResult').textContent = JSON.stringify(result, null, 2);

                showStatus('status3', 'âœ“ åŠ å¯†æµ‹è¯•æˆåŠŸï¼', 'success');
                testResults.encryption = true;
            } catch (error) {
                console.error('åŠ å¯†æµ‹è¯•å¤±è´¥:', error);
                document.getElementById('encryptionResult').textContent = `é”™è¯¯: ${error.message}`;
                showStatus('status3', `âœ— åŠ å¯†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.encryption = false;
            }

            updateSummary();
        }

        // æµ‹è¯• 4ï¼šå®Œæ•´ç™»å½•æµ‹è¯•
        async function testLogin() {
            try {
                const formattedKey = document.getElementById('formattedPublicKey').value;
                const username = document.getElementById('testUsername').value;
                const password = document.getElementById('testPasswordLogin').value;

                if (!formattedKey) {
                    throw new Error('è¯·å…ˆæ ¼å¼åŒ–å…¬é’¥');
                }

                showStatus('status4', 'æ­£åœ¨æ‰§è¡Œç™»å½•æµ‹è¯•...', 'info');

                // åŠ å¯†å¯†ç 
                const encrypt = new JSEncrypt();
                encrypt.setPublicKey(formattedKey);
                const encryptedPassword = encrypt.encrypt(password);

                if (encryptedPassword === false) {
                    throw new Error('å¯†ç åŠ å¯†å¤±è´¥');
                }

                // å‘é€ç™»å½•è¯·æ±‚
                const requestBody = {
                    username: username,
                    password: encryptedPassword,
                    encrypted: true
                };

                const response = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const responseData = await response.json();

                const result = {
                    è¯·æ±‚URL: 'http://localhost:8080/api/auth/login',
                    è¯·æ±‚ä½“: {
                        username: username,
                        password: encryptedPassword.substring(0, 50) + '...',
                        encrypted: true
                    },
                    å“åº”çŠ¶æ€: response.status,
                    å“åº”æ•°æ®: responseData
                };

                document.getElementById('loginResult').textContent = JSON.stringify(result, null, 2);

                if (response.ok && responseData.success) {
                    showStatus('status4', 'âœ“ ç™»å½•æµ‹è¯•æˆåŠŸï¼', 'success');
                    testResults.login = true;
                } else {
                    throw new Error(`ç™»å½•å¤±è´¥: ${responseData.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('ç™»å½•æµ‹è¯•å¤±è´¥:', error);
                showStatus('status4', `âœ— ç™»å½•æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                testResults.login = false;
            }

            updateSummary();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œæµ‹è¯•
        window.addEventListener('load', async function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');

            // è‡ªåŠ¨æ‰§è¡Œæµ‹è¯• 1
            await testGetPublicKey();

            // å»¶è¿Ÿ 500ms åæ‰§è¡Œæµ‹è¯• 2
            setTimeout(() => {
                testFormatPublicKey();
            }, 500);

            // å»¶è¿Ÿ 1000ms åæ‰§è¡Œæµ‹è¯• 3
            setTimeout(() => {
                testEncryption();
            }, 1000);
        });
    </script>
</body>
</html>
